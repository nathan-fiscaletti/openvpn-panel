#!/bin/bash

CLIENT=$1
CSTORE=$2

cd /etc/openvpn/easy-rsa/
./easyrsa --batch revoke $CLIENT
./easyrsa gen-crl
rm -rf pki/reqs/$CLIENT.req
rm -rf pki/private/$CLIENT.key
rm -rf pki/issued/$CLIENT.crt
rm -rf /etc/openvpn/crl.pem
cp /etc/openvpn/easy-rsa/pki/crl.pem /etc/openvpn/crl.pem

rm -rf $CSTORE/$CLIENT.ovpn

chown nobody:nogroup /etc/openvpn/crl.pem

echo "Restarting Server..."

for p in `screen -ls | grep ServerOpenVPN | awk '{print $1}' | cut -d. -f1`; do kill -9 $p; done;
screen -wipe


function read_config()
{
    echo $(awk -F "=" '/'$1'/ {print $2}' ./config/$2.ini) | tr -d ' ' 
}

for p in `screen -ls | grep ServerOpenVPN | awk '{print $1}' | cut -d. -f1`; do kill -9 $p; done;
screen -wipe

OVPN=`read_config 'ovpn' 'server'`
screen -A -m -d -S ServerOpenVPN ./bin/ovpn $OVPN